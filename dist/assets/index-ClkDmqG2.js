import{r as a,j as e}from"./index-DRYYJggy.js";import{m as f}from"./mock-rGEZ3HGA.js";import{f as K}from"./index-Cv2_veDm.js";import{u as U}from"./user-CTfc_bTd.js";import{F as l,R as G,C as S,I as J,B as x,a as Q,s as X}from"./index-DQU_F6Fm.js";import{P as Z,R as ee,b as te}from"./Table-CL1K4gcX.js";import{M as I}from"./index-DayXL3Em.js";import{S as j,T as F,F as se}from"./Table-6zcBRtZI.js";import{C as g}from"./index-CN7zSww5.js";import{S as b}from"./index-CeGTmvvs.js";import"./index-C1WG2uQ_.js";import"./index-Bj386uoF.js";import"./context-Bi0jcZUX.js";import"./CloseOutlined-BqKTODZs.js";import"./index-B74T4Ixe.js";import"./EllipsisOutlined-BVGyxfd1.js";import"./index-CBuGrdmH.js";import"./PlusOutlined-CDU51U6T.js";import"./index-BBcq28iL.js";const{TextArea:ie}=J,Ie=()=>{const D=a.useRef(null),[d]=l.useForm(),[B,y]=a.useState(!1),[M,v]=a.useState(!1),[k,w]=a.useState(!1),[c,V]=a.useState(null),[h,T]=a.useState(null),[z,H]=a.useState([]),{user:C}=U(),[R,N]=a.useState([]),[m,E]=a.useState([]);a.useEffect(()=>{(async()=>{const s=await f.getProjects(),i=await f.getTasks();N(s),E(i)})()},[]);const q=t=>{const s=new Date,i=new Date(t),r=new Date(i.getFullYear(),i.getMonth()+1,10);return s<r},_=t=>{V(t);const s={date:t.date,requiredHours:t.requiredHours};t.tasks.forEach(i=>{const r=m.find(n=>n.name===i.taskName);r&&(s[`hours_${r.id}`]=i.hours,s[`desc_${r.id}`]=i.description)}),d.setFieldsValue(s),y(!0)},$=t=>{T(t),v(!0)},L=async t=>{const s=await f.getLeaveRecords(),i=new Date(t.date),r=i.getFullYear(),n=i.getMonth()+1,p=s.filter(u=>{const o=new Date(u.startDate);return o.getFullYear()===r&&o.getMonth()+1===n});H(p),w(!0)},A=async()=>{try{const t=await d.validateFields(),s=[];Object.keys(t).forEach(i=>{if(i.startsWith("hours_")){const r=i.replace("hours_",""),n=t[i],p=`desc_${r}`,u=t[p];if(n&&n>0){const o=m.find(Y=>Y.id===r);o&&s.push({taskId:o.id,taskName:o.name,projectName:o.projectName,hours:n,description:u})}}}),X.success(c?"更新成功":"创建成功"),y(!1),D.current?.reload()}catch(t){console.error("Validation failed:",t)}},O=()=>c?`编辑月报 - ${new Date(c.date).toLocaleDateString("zh-CN",{year:"numeric",month:"long"})} - ${c.userName}`:"新增月报",W=[{title:"请假类型",dataIndex:"leaveType",width:120,render:t=>({annual:"年假",sick:"病假",personal:"事假",maternity:"产假",other:"其他"})[t]||t},{title:"开始日期",dataIndex:"startDate",width:120},{title:"结束日期",dataIndex:"endDate",width:120},{title:"请假时长",dataIndex:"days",width:100,render:t=>e.jsxs("span",{children:[t,"天"]})}],P=[{title:"月份",dataIndex:"date",width:120,render:(t,s)=>s.date?new Date(s.date).toLocaleDateString("zh-CN",{year:"numeric",month:"long"}):"-"},{title:"实报工时",dataIndex:"totalHours",width:100,valueType:"digit",hideInSearch:!0,render:t=>e.jsx("span",{style:{fontWeight:600},children:t})},{title:"应报工时",dataIndex:"requiredHours",width:120,valueType:"digit",hideInSearch:!0,render:t=>e.jsx("span",{style:{fontWeight:600,color:"#FA8C16"},children:t})},{title:"请假情况",dataIndex:"leave",width:100,hideInSearch:!0,render:(t,s)=>e.jsx(x,{type:"link",size:"small",icon:e.jsx(ee,{}),onClick:()=>L(s),children:"查看"})},{title:"提交时间",dataIndex:"submitTime",width:180,hideInSearch:!0},{title:"操作",valueType:"option",width:180,fixed:"right",render:(t,s)=>{const i=q(s.date);return[e.jsx(x,{type:"link",size:"small",icon:e.jsx(Q,{}),onClick:()=>$(s),children:"查看"},"view"),i&&e.jsx(x,{type:"link",size:"small",icon:e.jsx(te,{}),onClick:()=>_(s),children:"编辑"},"edit")].filter(Boolean)}}];return e.jsxs("div",{children:[e.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:e.jsx("h2",{style:{fontSize:"20px",fontWeight:600,margin:0},children:"我的月报"})}),e.jsx(Z,{columns:P,actionRef:D,search:!1,request:async()=>{if(!C?.id)return{data:[],success:!0,total:0};const s=(await f.getMonthReports()).filter(i=>i.userId===C?.id);return{data:s,success:!0,total:s.length}},rowKey:"id",pagination:{defaultPageSize:10,showSizeChanger:!0},dateFormatter:"string",headerTitle:"我的月报",scroll:{x:1e3,y:"calc(100vh - 350px)"},options:{density:!1,fullScreen:!1,reload:!0,setting:!1}}),e.jsx(I,{title:O(),open:B,onOk:A,onCancel:()=>y(!1),width:900,children:e.jsxs(l,{form:d,layout:"vertical",children:[!c&&e.jsxs(e.Fragment,{children:[e.jsx(l.Item,{name:"date",label:"填报日期",rules:[{required:!0,message:"请选择填报日期"}],children:e.jsxs(j,{style:{width:"100%"},placeholder:"请选择月份",children:[e.jsx(j.Option,{value:"2026-01",children:"2026年1月"}),e.jsx(j.Option,{value:"2026-02",children:"2026年2月"}),e.jsx(j.Option,{value:"2026-03",children:"2026年3月"})]})}),e.jsx(l.Item,{name:"totalHours",label:"总工时",rules:[{required:!0,message:"请输入总工时"}],children:e.jsx(F,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入总工时"})}),e.jsx(l.Item,{name:"requiredHours",label:"应报工时",rules:[{required:!0,message:"请输入应报工时"}],children:e.jsx(F,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入应报工时"})})]}),e.jsx(l.Item,{noStyle:!0,shouldUpdate:(t,s)=>t!==s,children:()=>{let t=0;Object.keys(d.getFieldsValue()).forEach(r=>{r.startsWith("hours_")&&(t+=d.getFieldValue(r)||0)});const s=d.getFieldValue("requiredHours")||0,i=s-t;return e.jsx(g,{size:"small",style:{marginBottom:16,background:"#f0f0f0"},children:e.jsxs(G,{gutter:16,children:[e.jsx(S,{span:8,children:e.jsx(b,{title:"实报工时",value:t,suffix:"h",valueStyle:{color:"#1677FF"}})}),e.jsx(S,{span:8,children:e.jsx(b,{title:"应报工时",value:s,suffix:"h",valueStyle:{color:"#FA8C16"}})}),e.jsx(S,{span:8,children:e.jsx(b,{title:"合计剩余",value:i,suffix:"h",valueStyle:{color:i<0?"#FF4D4F":"#52C41A"}})})]})})}}),e.jsx(l.Item,{label:"任务列表",children:e.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto"},children:[R.filter(t=>m.some(s=>s.projectId===t.id)).map(t=>{const s=m.filter(r=>r.projectId===t.id),i=s.reduce((r,n)=>r+n.remainingHours,0);return e.jsx(g,{size:"small",style:{marginBottom:16},title:`${t.name} (可用: ${i}h)`,children:s.map(r=>{const n=`hours_${r.id}`,p=`desc_${r.id}`,u=c?.tasks.find(o=>o.taskName===r.name);return e.jsxs("div",{style:{marginBottom:12,paddingBottom:12,borderBottom:"1px solid #f0f0f0"},children:[e.jsxs("div",{style:{display:"flex",gap:"16px",marginBottom:8},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"任务名称"}),e.jsxs("div",{style:{fontSize:"14px",fontWeight:500},children:[r.name," ",e.jsxs("span",{style:{fontSize:"12px",color:"#52C41A",marginLeft:8},children:["(可用: ",r.remainingHours,"h)"]})]})]}),e.jsxs("div",{style:{width:"150px"},children:[e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"消耗工时"}),e.jsx(l.Item,{name:n,initialValue:u?.hours,style:{marginBottom:0},children:e.jsx(F,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入工时"})})]})]}),e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"任务详情"}),e.jsx(l.Item,{name:p,initialValue:u?.description,style:{marginBottom:0},children:e.jsx(ie,{rows:2,placeholder:"请输入任务详情",style:{width:"100%"}})})]})]},r.id)})},t.id)}),R.filter(t=>m.some(s=>s.projectId===t.id)).length===0&&e.jsx("div",{style:{textAlign:"center",color:"#999",padding:"40px"},children:"暂无项目数据"})]})})]})}),e.jsx(I,{title:"查看月报",open:M,onCancel:()=>v(!1),footer:[e.jsx(x,{onClick:()=>v(!1),children:"关闭"},"close")],width:800,children:h&&e.jsxs("div",{children:[e.jsxs(g,{size:"small",style:{marginBottom:16},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"填报人："}),h.userName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"填报日期："}),K(h.date)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总工时："}),h.totalHours]}),e.jsxs("p",{children:[e.jsx("strong",{children:"应报工时："}),h.requiredHours]})]}),e.jsx(g,{size:"small",title:"任务",children:h.tasks.map((t,s)=>e.jsxs("div",{style:{marginBottom:12,padding:"12px",border:"1px solid #E5E6EB",borderRadius:"4px"},children:[e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"项目："}),t.projectName]}),e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"任务："}),t.taskName]}),e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"工时："}),t.hours,"h"]}),t.description&&e.jsxs("div",{children:[e.jsx("strong",{children:"详情："}),t.description]})]},s))})]})}),e.jsx(I,{title:"当月请假情况",open:k,onCancel:()=>w(!1),footer:[e.jsx(x,{onClick:()=>w(!1),children:"关闭"},"close")],width:800,children:e.jsx(se,{columns:W,dataSource:z,rowKey:"id",pagination:!1,locale:{emptyText:"当月无请假记录"}})})]})};export{Ie as default};
