import{r as o,j as e}from"./index-CAiBCleG.js";import{m as y}from"./mock-rGEZ3HGA.js";import{f as ne}from"./index-kMJN4w24.js";import{u as ae}from"./user-B-lm-bHV.js";import{F as l,R as le,C as R,I as oe,B as d,a as de,s as ce}from"./index-swGlYUjQ.js";import{P as he,b as L,R as ue}from"./Table-tBS6Uq_V.js";import{M as B}from"./index-D_huDtZH.js";import{S as u,T as V,F as me}from"./Table-C_qFrlVF.js";import{C as z}from"./index-Cfn1rbCW.js";import{S as D}from"./index-Cztx3cHy.js";import{R as xe}from"./PlusOutlined-gP3SYvho.js";import"./index-DQfW_aVs.js";import"./index-DBy6f6Xv.js";import"./context-Z3YCD4ih.js";import"./CloseOutlined-HWTcD8NI.js";import"./index-rppOOmUr.js";import"./EllipsisOutlined-DhqJwpys.js";import"./index-D6x7_msS.js";import"./index-ycXrrK2V.js";const{TextArea:pe}=oe,Me=()=>{const T=o.useRef(null),[a]=l.useForm(),[O,v]=o.useState(!1),[A,k]=o.useState(!1),[$,w]=o.useState(!1),[x,W]=o.useState(null),[m,U]=o.useState(null),[Y,_]=o.useState([]),[p,N]=o.useState(null),{user:M}=ae(),[S,K]=o.useState([]),[g,G]=o.useState([]);o.useEffect(()=>{(async()=>{const s=await y.getProjects(),i=await y.getTasks();K(s),G(i)})()},[]);const J=t=>{const s=new Date,i=new Date(t),c=new Date(i.getFullYear(),i.getMonth()+1,10);return s<c},Q=t=>{W(t),a.setFieldsValue({...t,date:t.date}),v(!0)},X=t=>{U(t),k(!0)},Z=async t=>{const s=await y.getLeaveRecords(),i=new Date(t.date),c=i.getFullYear(),r=i.getMonth()+1,h=s.filter(I=>{const F=new Date(I.startDate);return F.getFullYear()===c&&F.getMonth()+1===r});_(h),w(!0)},ee=async()=>{try{await a.validateFields(),ce.success(x?"更新成功":"创建成功"),v(!1),T.current?.reload()}catch(t){console.error("Validation failed:",t)}},te=()=>x?`编辑月报 - ${new Date(x.date).toLocaleDateString("zh-CN",{year:"numeric",month:"long"})} - ${x.userName}`:"新增月报",se=[{title:"请假类型",dataIndex:"leaveType",width:120,render:t=>({annual:"年假",sick:"病假",personal:"事假",maternity:"产假",other:"其他"})[t]||t},{title:"开始日期",dataIndex:"startDate",width:120},{title:"结束日期",dataIndex:"endDate",width:120},{title:"请假时长",dataIndex:"days",width:100,render:t=>e.jsxs("span",{children:[t,"天"]})}],re=[{title:"月份",dataIndex:"date",width:120,render:(t,s)=>s.date?new Date(s.date).toLocaleDateString("zh-CN",{year:"numeric",month:"long"}):"-"},{title:"实报工时",dataIndex:"totalHours",width:100,valueType:"digit",hideInSearch:!0,render:t=>e.jsx("span",{style:{fontWeight:600},children:t})},{title:"应报工时",dataIndex:"requiredHours",width:120,valueType:"digit",hideInSearch:!0,render:t=>e.jsx("span",{style:{fontWeight:600,color:"#FA8C16"},children:t})},{title:"请假情况",dataIndex:"leave",width:100,hideInSearch:!0,render:(t,s)=>e.jsx(d,{type:"link",size:"small",icon:e.jsx(ue,{}),onClick:()=>Z(s),children:"查看"})},{title:"提交时间",dataIndex:"submitTime",width:180,hideInSearch:!0},{title:"操作",valueType:"option",width:180,fixed:"right",render:(t,s)=>{const i=J(s.date);return[e.jsx(d,{type:"link",size:"small",icon:e.jsx(de,{}),onClick:()=>X(s),children:"查看"},"view"),i&&e.jsx(d,{type:"link",size:"small",icon:e.jsx(L,{}),onClick:()=>Q(s),children:"编辑"},"edit")].filter(Boolean)}}];return e.jsxs("div",{children:[e.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"24px"},children:e.jsx("h2",{style:{fontSize:"20px",fontWeight:600,margin:0},children:"我的月报"})}),e.jsx(he,{columns:re,actionRef:T,search:!1,request:async()=>{if(!M?.id)return{data:[],success:!0,total:0};const s=(await y.getMonthReports()).filter(i=>i.userId===M?.id);return{data:s,success:!0,total:s.length}},rowKey:"id",pagination:{defaultPageSize:10,showSizeChanger:!0},dateFormatter:"string",headerTitle:"我的月报",scroll:{x:1e3,y:"calc(100vh - 350px)"},options:{density:!1,fullScreen:!1,reload:!0,setting:!1}}),e.jsx(B,{title:te(),open:O,onOk:ee,onCancel:()=>v(!1),width:900,children:e.jsxs(l,{form:a,layout:"vertical",children:[!x&&e.jsxs(e.Fragment,{children:[e.jsx(l.Item,{name:"date",label:"填报日期",rules:[{required:!0,message:"请选择填报日期"}],children:e.jsxs(u,{style:{width:"100%"},placeholder:"请选择月份",children:[e.jsx(u.Option,{value:"2026-01",children:"2026年1月"}),e.jsx(u.Option,{value:"2026-02",children:"2026年2月"}),e.jsx(u.Option,{value:"2026-03",children:"2026年3月"})]})}),e.jsx(l.Item,{name:"totalHours",label:"总工时",rules:[{required:!0,message:"请输入总工时"}],children:e.jsx(V,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入总工时"})}),e.jsx(l.Item,{name:"requiredHours",label:"应报工时",rules:[{required:!0,message:"请输入应报工时"}],children:e.jsx(V,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入应报工时"})})]}),e.jsx(l.Item,{noStyle:!0,shouldUpdate:(t,s)=>t!==s,children:()=>{const s=(a.getFieldValue("tasks")||[]).reduce((r,h)=>r+(h?.hours??0),0),i=a.getFieldValue("requiredHours")||0,c=i-s;return e.jsx(z,{size:"small",style:{marginBottom:16,background:"#f0f0f0"},children:e.jsxs(le,{gutter:16,children:[e.jsx(R,{span:8,children:e.jsx(D,{title:"实报工时",value:s,suffix:"h",valueStyle:{color:"#1677FF"}})}),e.jsx(R,{span:8,children:e.jsx(D,{title:"应报工时",value:i,suffix:"h",valueStyle:{color:"#FA8C16"}})}),e.jsx(R,{span:8,children:e.jsx(D,{title:"合计剩余",value:c,suffix:"h",valueStyle:{color:c<0?"#FF4D4F":"#52C41A"}})})]})})}}),e.jsx(l.Item,{label:"任务列表",children:e.jsx(l.List,{name:"tasks",children:(t,{add:s,remove:i})=>e.jsxs(e.Fragment,{children:[t.map(({key:c,name:r,...h})=>{const I=a.getFieldValue(["tasks",r,"projectName"]),E=S.find(n=>n.name===I)?.id||"",H=E?g.filter(n=>n.projectId===E):g;return e.jsxs("div",{style:{border:"1px solid #E5E6EB",padding:"16px",marginBottom:"16px",borderRadius:"4px"},children:[e.jsxs("div",{style:{display:"flex",gap:"12px",marginBottom:12},children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"项目"}),p===r?e.jsx(l.Item,{...h,name:[r,"projectName"],rules:[{required:!0,message:"请选择项目"}],style:{marginBottom:0},children:e.jsx(u,{placeholder:"请选择项目",style:{width:"100%"},onChange:()=>{a.setFieldValue(["tasks",r,"taskName"],void 0),a.setFieldValue(["tasks",r,"hours"],void 0)},children:S.map(n=>e.jsx(u.Option,{value:n.name,children:n.name},n.id))})}):e.jsx("div",{style:{fontSize:"14px"},children:a.getFieldValue(["tasks",r,"projectName"])||"-"})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"任务"}),p===r?e.jsx(l.Item,{...h,name:[r,"taskName"],rules:[{required:!0,message:"请选择任务"}],style:{marginBottom:0},children:e.jsx(u,{placeholder:"请选择任务",style:{width:"100%"},disabled:H.length===0,children:H.map(n=>e.jsx(u.Option,{value:n.name,children:n.name},n.id))})}):e.jsx("div",{style:{fontSize:"14px"},children:a.getFieldValue(["tasks",r,"taskName"])||"-"})]})]}),p===r&&e.jsx(l.Item,{noStyle:!0,shouldUpdate:(n,P)=>{const f=n?.tasks?.[r]?.taskName,b=P?.tasks?.[r]?.taskName;return f!==b},children:()=>{const n=a.getFieldValue(["tasks",r,"projectName"]),f=S.find(j=>j.name===n)?.id||"",b=f?g.filter(j=>j.projectId===f):g,ie=a.getFieldValue(["tasks",r,"taskName"]),C=b.find(j=>j.name===ie),q=C?C.remainingHours:0;return e.jsx("div",{style:{marginBottom:12},children:e.jsx(l.Item,{...h,name:[r,"hours"],label:"工时",rules:[{required:!0,message:"请输入工时"}],style:{marginBottom:0},children:e.jsx(V,{min:0,step:.5,style:{width:"100%"},placeholder:"请输入工时",addonAfter:C?e.jsxs("span",{style:{color:q<0?"#FF4D4F":"#52C41A",fontSize:"12px",fontWeight:600},children:["剩余: ",q,"h"]}):null})})})}}),e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"工时"}),e.jsxs("div",{style:{fontSize:"14px",marginBottom:12},children:[a.getFieldValue(["tasks",r,"hours"])||0,"h"]}),e.jsx("div",{style:{fontSize:"12px",color:"#999",marginBottom:4},children:"详情"}),p===r?e.jsx(l.Item,{...h,name:[r,"description"],style:{marginBottom:12},children:e.jsx(pe,{rows:3,placeholder:"请输入任务详情"})}):e.jsx("div",{style:{fontSize:"14px",minHeight:"60px",padding:"8px",background:"#f5f5f5",borderRadius:"4px",marginBottom:12},children:a.getFieldValue(["tasks",r,"description"])||"暂无详情"}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[p===r?e.jsx(d,{type:"primary",size:"small",onClick:()=>N(null),children:"保存"}):e.jsx(d,{size:"small",icon:e.jsx(L,{}),onClick:()=>N(r),children:"编辑"}),e.jsx(d,{size:"small",danger:!0,onClick:()=>i(r),children:"删除"})]})]},c)}),e.jsx(l.Item,{children:e.jsx(d,{type:"dashed",onClick:()=>s(),block:!0,icon:e.jsx(xe,{}),children:"添加任务"})})]})})})]})}),e.jsx(B,{title:"查看月报",open:A,onCancel:()=>k(!1),footer:[e.jsx(d,{onClick:()=>k(!1),children:"关闭"},"close")],width:800,children:m&&e.jsxs("div",{children:[e.jsxs(z,{size:"small",style:{marginBottom:16},children:[e.jsxs("p",{children:[e.jsx("strong",{children:"填报人："}),m.userName]}),e.jsxs("p",{children:[e.jsx("strong",{children:"填报日期："}),ne(m.date)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"总工时："}),m.totalHours]}),e.jsxs("p",{children:[e.jsx("strong",{children:"应报工时："}),m.requiredHours]})]}),e.jsx(z,{size:"small",title:"任务",children:m.tasks.map((t,s)=>e.jsxs("div",{style:{marginBottom:12,padding:"12px",border:"1px solid #E5E6EB",borderRadius:"4px"},children:[e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"项目："}),t.projectName]}),e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"任务："}),t.taskName]}),e.jsxs("div",{style:{marginBottom:8},children:[e.jsx("strong",{children:"工时："}),t.hours,"h"]}),t.description&&e.jsxs("div",{children:[e.jsx("strong",{children:"详情："}),t.description]})]},s))})]})}),e.jsx(B,{title:"当月请假情况",open:$,onCancel:()=>w(!1),footer:[e.jsx(d,{onClick:()=>w(!1),children:"关闭"},"close")],width:800,children:e.jsx(me,{columns:se,dataSource:Y,rowKey:"id",pagination:!1,locale:{emptyText:"当月无请假记录"}})})]})};export{Me as default};
